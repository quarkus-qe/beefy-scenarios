# Quarkus  / Vert.x security scenario  

In order to test Quarkus / Vertx extension security, we have set up an HTTP server with Vertx [Reactive Routes](https://quarkus.io/guides/reactive-routes#using-the-vert-x-web-router).
Basically Vertx it's an event loop that handler any kind of request as an event (Async and non-blocking). In this case the events are going to be generated by an HTTP-client, for example a browser. 
This event is going to be managed by a Router (Application.class), that based on some criteria, will dispatch these events to an existing handler. 

![Vertx Diagram](docs/VertxConceptual.png)

When a handler ends with a request, could reply a response or could propagate this request to the next handler (Handler chain approach). By this way you can segregate responsibilities between handlers. 
In our case we are going to have several handlers. 

Example:

```
this.router.get("/secured")
                .handler(CorsHandler.create("*")) 
                .handler(LoggerHandler.create()) 
                .handler(JWTAuthHandler.create(authN)) 
                .handler(authZ::authorize) 
                .handler(rc -> secure.helloWorld(rc)); 
```

* CorsHandler: add cross origin headers to the HTTP response
* LoggerHandler: log each request and response
* JWTAuthHandler: make JWT authentication task, using a given AuthN provider.
* authZ::authorize: custom AuthZ(authorization) provider.
* secure.helloWorld(rc): actual http endpoint (Rest layer).

## Recommended Readings

[Vertx Auth JWT](https://vertx.io/docs/vertx-auth-jwt/java/)

[Reactive Routes](https://quarkus.io/guides/reactive-routes)

[Reactive Redis](https://quarkus.io/guides/redis)

## Requirements

To compile and run this demo you will need:

- JDK 11+
- Docker

## Scope of the testing

Quarkus / Vertx JWT (AuthN/Z) exploratory testing

* AuthN
    * Validate JWT token: iss, ext, iat, aud
    * Validate JWT signature
* AuthZ (pending)
* Quarkus Vertx Reactive Routes
* OpenAPI from static yaml
* Reactive Redis

## Useful material

Launch Redis: `docker run -p 6379:6379 -d redis`

Swagger: `http://localhost:8080/q/swagger-ui/`

VoightKampff test: `http://localhost:8080/VoightKampffTest.html`

Create replicant example: 
```
curl -v -H "authorization: bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1lIjpudWxsLCJzdWIiOiJiZmYiLCJpc3MiOiJ2ZXJ0eEpXVEByZWRoYXQuY29tIiwiYXVkIjoidGhpcmRfcGFydHkiLCJncm91cHMiOlsiYWRtaW4iXSwiaWF0IjoxNjA5NzUzODI0LCJleHAiOjE2MDk3NTQ0MjR9.bTaFX4bMeGtms1DXirc_btqqlEF_R6mRS_5LvNuhCFg" -X POST "http://localhost:8080/replicant" -d '{"id": "7777", "model": "nexus-5", "liveSpanYears":5, "name": "Alan", "lastName": "Bregg", "specialAbilities":[], "geneticsModifications":[]}'
```

Create BladeRunner example:
```
curl -v -H "authorization: bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1lIjpudWxsLCJzdWIiOiJiZmYiLCJpc3MiOiJ2ZXJ0eEpXVEByZWRoYXQuY29tIiwiYXVkIjoidGhpcmRfcGFydHkiLCJncm91cHMiOlsiYWRtaW4iXSwiaWF0IjoxNjA5NzUzODI0LCJleHAiOjE2MDk3NTQ0MjR9.bTaFX4bMeGtms1DXirc_btqqlEF_R6mRS_5LvNuhCFg" -X POST "http://localhost:8080/bladeRunner" -d '{"id": "7777", "name": "Alan", "lastName": "Bregg", "geneticsModifications":[]}'
```

Get all replicants:
```
curl -v -H "authorization: bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1lIjpudWxsLCJzdWIiOiJiZmYiLCJpc3MiOiJ2ZXJ0eEpXVEByZWRoYXQuY29tIiwiYXVkIjoidGhpcmRfcGFydHkiLCJncm91cHMiOlsiYWRtaW4iXSwiaWF0IjoxNjA5NzUzODI0LCJleHAiOjE2MDk3NTQ0MjR9.bTaFX4bMeGtms1DXirc_btqqlEF_R6mRS_5LvNuhCFg" "http://localhost:8080/replicant" '
```

Get all bladeRunners:
```
curl -v -H "authorization: bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuYW1lIjpudWxsLCJzdWIiOiJiZmYiLCJpc3MiOiJ2ZXJ0eEpXVEByZWRoYXQuY29tIiwiYXVkIjoidGhpcmRfcGFydHkiLCJncm91cHMiOlsiYWRtaW4iXSwiaWF0IjoxNjA5NzUzODI0LCJleHAiOjE2MDk3NTQ0MjR9.bTaFX4bMeGtms1DXirc_btqqlEF_R6mRS_5LvNuhCFg" "http://localhost:8080/bladeRunner" '
```
 ### How you can generate your own JWT tokens (Development)
 
 You could use the following endpoint: `curl -v http://localhost:8080/jwt`
 
 
  
 

